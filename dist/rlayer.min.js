/*
 RaphaelLayer, a JavaScript library for overlaying Raphael objects onto Leaflet interactive maps. http://dynmeth.github.com/RaphaelLayer
 (c) 2012-2013, David Howell, Dynamic Methods Pty Ltd

 Version 0.1.3

 Fork by Arnooo: https://github.com/Arnooo/RaphaelLayer

*/

!function(){var t,e;"undefined"!=typeof exports?t=exports:(t={},e=window.R,t.noConflict=function(){return window.R=e,t},window.R=t),t.version="0.1.3",t.Layer=L.Class.extend({includes:L.Mixin.Events,initialize:function(){},onAdd:function(t){this._map=t,this._map._initRaphaelRoot(),this._paper=this._map._paper,this._set=this._paper.set(),t.on("viewreset",this.projectLatLngs,this),this.projectLatLngs()},onRemove:function(t){t.off("viewreset",this.projectLatLngs,this),this._map=null,this._set.forEach(function(t){t.remove()},this),this._set.clear()},projectLatLngs:function(){},animate:function(t,e,i,a){return this._set.animate(t,e,i,a),this},hover:function(t,e,i,a){return this._set.hover(t,e,i,a),this},attr:function(t,e){return this._set.attr(t,e),this}}),L.Map.include({_initRaphaelRoot:function(){this._raphaelRoot||(this._raphaelRoot=this._panes.overlayPane,this._paper=Raphael(this._raphaelRoot),this.on("moveend",this._updateRaphaelViewport),this._updateRaphaelViewport())},_updateRaphaelViewport:function(){console.log(L.Path.CLIP_PADDING);{var t=.02,e=this.getSize(),i=L.DomUtil.getPosition(this._mapPane),a=i.multiplyBy(-1)._subtract(e.multiplyBy(t)),o=a.add(e.multiplyBy(1+2*t)),s=o.x-a.x,n=o.y-a.y,r=this._raphaelRoot;this._panes.overlayPane}this._paper.setSize(s,n),L.DomUtil.setPosition(r,a),r.setAttribute("width",s),r.setAttribute("height",n),this._paper.setViewBox(a.x,a.y,s,n,!1)}}),t.Marker=t.Layer.extend({initialize:function(e,i,a,o){t.Layer.prototype.initialize.call(this,o),this._latlng=e,this._pathString="string"==typeof i?i:"M16,3.5c-4.142,0-7.5,3.358-7.5,7.5c0,4.143,7.5,18.121,7.5,18.121S23.5,15.143,23.5,11C23.5,6.858,20.143,3.5,16,3.5z M16,14.584c-1.979,0-3.584-1.604-3.584-3.584S14.021,7.416,16,7.416S19.584,9.021,19.584,11S17.979,14.584,16,14.584z",this._attr="object"==typeof i?i:a?a:{fill:"#000"}},projectLatLngs:function(){this._path&&this._path.remove();var t=this._map.latLngToLayerPoint(this._latlng),e=Raphael.pathBBox(this._pathString);this._path=this._paper.path(this._pathString).attr(this._attr).translate(t.x-1.05*e.width,t.y-1.15*e.height).toFront(),this._set.push(this._path)}}),t.Pulse=t.Layer.extend({initialize:function(e,i,a,o,s){t.Layer.prototype.initialize.call(this,s),this._latlng=e,this._radius="number"==typeof i?i:6,this._attr="object"==typeof i?i:"object"==typeof a?a:{fill:"#30a3ec",stroke:"#30a3ec"},this._pulseAttr="object"==typeof i?a:"object"==typeof o?o:{"stroke-width":3,stroke:this._attr.stroke},this._repeat=3},onRemove:function(e){t.Layer.prototype.onRemove.call(this,e),this._marker&&this._marker.remove(),this._pulse&&this._pulse.remove()},projectLatLngs:function(){this._marker&&this._marker.remove(),this._pulse&&this._pulse.remove();var t=this._map.latLngToLayerPoint(this._latlng);this._marker=this._paper.circle(t.x,t.y,this._radius).attr(this._attr),this._pulse=this._paper.circle(t.x,t.y,this._radius).attr(this._pulseAttr);var e=Raphael.animation({"0%":{transform:"s0.3",opacity:1},"100%":{transform:"s3.0",opacity:0,easing:"<"}},1e3);this._pulse.animate(e.repeat(this._repeat))}}),t.Polyline=t.Layer.extend({initialize:function(e,i,a){t.Layer.prototype.initialize.call(this,a),this._latlngs=e,this._attr=i||{fill:"#000",stroke:"#000"}},projectLatLngs:function(){this._set.clear(),this._path&&this._path.remove(),this._path=this._paper.path(this.getPathString()).attr(this._attr).toBack(),this._set.push(this._path)},getPathString:function(){for(var t=0,e=this._latlngs.length,i="";e>t;t++){var a=this._map.latLngToLayerPoint(this._latlngs[t]);i+=(t?"L":"M")+a.x+" "+a.y}return i}}),t.Polygon=t.Layer.extend({initialize:function(e,i,a){t.Layer.prototype.initialize.call(this,a),1==e.length&&e[0]instanceof Array&&(e=e[0]),this._latlngs=e,this._attr=i||{fill:"rgba(255, 0, 0, 0.5)",stroke:"#f00","stroke-width":2}},projectLatLngs:function(){this._path&&this._path.remove(),this._path=this._paper.path(this.getPathString()).attr(this._attr).toBack(),this._set.push(this._path)},getPathString:function(){for(var t=0,e=this._latlngs.length,i="";e>t;t++){var a=this._map.latLngToLayerPoint(this._latlngs[t]);i+=(t?"L":"M")+a.x+" "+a.y}return i+="Z"}}),t.PolygonGlow=t.Layer.extend({initialize:function(e,i,a){t.Layer.prototype.initialize.call(this,a),this._latlngs=e,this._attr=i||{fill:"rgba(255, 0, 0, 1)",stroke:"#f00","stroke-width":3}},onRemove:function(e){t.Layer.prototype.onRemove.call(this,e),this._path&&this._path.remove()},projectLatLngs:function(){this._path&&this._path.remove(),this._path=this._paper.path(this.getPathString()).attr(this._attr).toBack();var t=this._path,e=function(){t.animate({"fill-opacity":.25},1e3,"<",i)},i=function(){t.animate({"fill-opacity":1},1e3,"<",e)};i()},getPathString:function(){for(var t=0,e=this._latlngs.length,i="";e>t;t++){var a=this._map.latLngToLayerPoint(this._latlngs[t]);i+=(t?"L":"M")+a.x+" "+a.y}return i+="Z"}}),t.Bezier=t.Layer.extend({initialize:function(e,i,a){t.Layer.prototype.initialize.call(this,a),this._latlngs=e,this._attr=i},projectLatLngs:function(){this._path&&this._path.remove();var t=this._map.latLngToLayerPoint(this._latlngs[0]),e=this._map.latLngToLayerPoint(this._latlngs[1]),i=this.getControlPoint(t,e);this._path=this._paper.path("M"+t.x+" "+t.y+"Q"+i.x+" "+i.y+" "+e.x+" "+e.y).attr(this._attr).toBack(),this._set.push(this._path)},getControlPoint:function(t,e){var i={x:0,y:0};i.x=t.x+(e.x-[t.x])/2,i.y=t.y+(e.y-[t.y])/2;var a=0;return this.closeTo(t.x,e.x)&&!this.closeTo(t.y,e.y)?(a=1*(t.x-e.x)+15*(t.x>=e.x?1:-1),i.x=Math.max(t.x,e.x)+a):(a=1.5*(e.y-t.y)+15*(t.y<e.y?1:-1),i.y=Math.min(t.y,e.y)+a),i},closeTo:function(t,e){var i=15;return t-e>-i&&i>t-e}}),t.BezierAnim=t.Layer.extend({initialize:function(e,i,a,o){t.Layer.prototype.initialize.call(this,o),this._latlngs=e,this._attr=i,this._cb=a},onRemove:function(e){t.Layer.prototype.onRemove.call(this,e),this._path&&this._path.remove(),this._sub&&this._sub.remove()},projectLatLngs:function(){this._path&&this._path.remove(),this._sub&&this._sub.remove();var t=this,e=this._map.latLngToLayerPoint(this._latlngs[0]),i=this._map.latLngToLayerPoint(this._latlngs[1]),a=this.getControlPoint(e,i),o="M"+e.x+" "+e.y+"Q"+a.x+" "+a.y+" "+i.x+" "+i.y,s=this._paper.path(o).hide();this._paper.customAttributes.alongBezier=function(t){var e=this.data("reverse"),i=this.data("pathLength");return{path:this.data("bezierPath").getSubpath(e?(1-t)*i:0,e?i:t*i)}};var n=this._sub=this._paper.path().data("bezierPath",s).data("pathLength",s.getTotalLength()).data("reverse",!1).attr({stroke:"#f00",alongBezier:0,"stroke-width":3});n.stop().animate({alongBezier:1},500,function(){t._cb(),n.data("reverse",!0),n.stop().animate({alongBezier:0},500,function(){n.remove()})})},getControlPoint:function(t,e){var i={x:0,y:0};i.x=t.x+(e.x-[t.x])/2,i.y=t.y+(e.y-[t.y])/2;var a=0;return this.closeTo(t.x,e.x)&&!this.closeTo(t.y,e.y)?(a=1*(t.x-e.x)+15*(t.x>=e.x?1:-1),i.x=Math.max(t.x,e.x)+a):(a=1.5*(e.y-t.y)+15*(t.y<e.y?1:-1),i.y=Math.min(t.y,e.y)+a),i},closeTo:function(t,e){var i=15;return t-e>-i&&i>t-e}}),t.FeatureGroup=L.FeatureGroup.extend({initialize:function(t,e){L.FeatureGroup.prototype.initialize.call(this,t,e)},animate:function(t,e,i,a){this.eachLayer(function(o){o.animate(t,e,i,a)})},onAdd:function(t){L.FeatureGroup.prototype.onAdd.call(this,t),this._set=this._map._paper.set();for(i in this._layers)this._set.push(this._layers[i]._set)},hover:function(t,e,i,a){return this.eachLayer(function(o){o.hover(t,e,i,a)}),this},attr:function(t,e){return this.eachLayer(function(i){i.attr(t,e)}),this}}),function(){function e(e){return t.FeatureGroup.extend({initialize:function(t,e){this._layers={},this._options=e,this.setLatLngs(t)},setLatLngs:function(t){var i=0,a=t.length;for(this.eachLayer(function(e){a>i?e.setLatLngs(t[i++]):this.removeLayer(e)},this);a>i;)this.addLayer(new e(t[i++],this._options));return this}})}t.MultiPolyline=e(t.Polyline),t.MultiPolygon=e(t.Polygon)}(),t.GeoJSON=t.FeatureGroup.extend({initialize:function(t,e){L.Util.setOptions(this,e),this._geojson=t,this._layers={},t&&this.addGeoJSON(t)},addGeoJSON:function(e){var i,a,o=e.features;if(o)for(i=0,a=o.length;a>i;i++)this.addGeoJSON(o[i]);else{var s="Feature"===e.type,n=s?e.geometry:e,r=t.GeoJSON.geometryToLayer(n,this.options.pointToLayer);this.fire("featureparse",{layer:r,properties:e.properties,geometryType:n.type,bbox:e.bbox,id:e.id,geometry:e.geometry}),this.addLayer(r)}}}),L.Util.extend(t.GeoJSON,{geometryToLayer:function(e,i){var a,o,s,n,r,h=e.coordinates,l=[];switch(e.type){case"Point":return a=this.coordsToLatLng(h),i?i(a):new t.Marker(a);case"MultiPoint":for(s=0,n=h.length;n>s;s++)a=this.coordsToLatLng(h[s]),r=i?i(a):new t.Marker(a),l.push(r);return new t.FeatureGroup(l);case"LineString":return o=this.coordsToLatLngs(h),new t.Polyline(o);case"Polygon":return o=this.coordsToLatLngs(h,1),new t.Polygon(o);case"MultiLineString":return o=this.coordsToLatLngs(h,1),new t.MultiPolyline(o);case"MultiPolygon":return o=this.coordsToLatLngs(h,2),new t.MultiPolygon(o);case"GeometryCollection":for(s=0,n=e.geometries.length;n>s;s++)r=this.geometryToLayer(e.geometries[s],i),l.push(r);return new t.FeatureGroup(l);default:throw new Error("Invalid GeoJSON object.")}},coordsToLatLng:function(t,e){var i=parseFloat(t[e?0:1]),a=parseFloat(t[e?1:0]);return new L.LatLng(i,a,!0)},coordsToLatLngs:function(t,e,i){var a,o,s,n=[];for(o=0,s=t.length;s>o;o++)a=e?this.coordsToLatLngs(t[o],e-1,i):this.coordsToLatLng(t[o],i),n.push(a);return n}})}();