/*
 RaphaelLayer, a JavaScript library for overlaying Raphael objects onto Leaflet interactive maps. http://dynmeth.github.com/RaphaelLayer
 (c) 2012-2013, David Howell, Dynamic Methods Pty Ltd

 Version 0.1.3

 Fork by Arnooo: https://github.com/Arnooo/RaphaelLayer

*/

!function(){var t,e;"undefined"!=typeof exports?t=exports:(t={},e=window.R,t.noConflict=function(){return window.R=e,t},window.R=t),t.version="0.1.3",t.Layer=L.Class.extend({includes:L.Mixin.Events,initialize:function(t){this.options=t},onAdd:function(t){this._map=t,this._map._initRaphaelRoot(),this._paper=this._map._paper,this._set=this._paper.set(),t.on("viewreset",this.projectLatLngs,this),t.on("resize",this.projectLatLngs,this),this.projectLatLngs()},onRemove:function(t){t.off("viewreset",this.projectLatLngs,this),t.off("resize",this.projectLatLngs,this),this._map=null,this._set.forEach(function(t){t.remove()},this),this._set.clear()},projectLatLngs:function(){},animate:function(t,i,e,a){return this._set.animate(t,i,e,a),this},hover:function(t,i,e,a){return this._set.hover(t,i,e,a),this},attr:function(t,i){return this._set.attr(t,i),this}}),L.Map.include({_initRaphaelRoot:function(){this._raphaelRoot||(this._raphaelRoot=this._panes.overlayPane,this._paper=Raphael(this._raphaelRoot),this.on("moveend",this._updateRaphaelViewport),this._updateRaphaelViewport())},_updateRaphaelViewport:function(){{var t=L.Path.CLIP_PADDING,i=this.getSize(),e=L.DomUtil.getPosition(this._mapPane),a=e.multiplyBy(-1)._subtract(i.multiplyBy(t)),r=a.add(i.multiplyBy(1+2*t)),o=r.x-a.x,n=r.y-a.y,s=this._raphaelRoot;this._panes.overlayPane}this._paper.setSize(o,n),L.DomUtil.setPosition(s,a),s.setAttribute("width",o),s.setAttribute("height",n),this._paper.setViewBox(a.x,a.y,o,n,!1)}}),t.Marker=t.Layer.extend({initialize:function(i,e,a,r){t.Layer.prototype.initialize.call(this,r),this._latlng=i,this._pathString="string"==typeof e?e:"M16,3.5c-4.142,0-7.5,3.358-7.5,7.5c0,4.143,7.5,18.121,7.5,18.121S23.5,15.143,23.5,11C23.5,6.858,20.143,3.5,16,3.5z M16,14.584c-1.979,0-3.584-1.604-3.584-3.584S14.021,7.416,16,7.416S19.584,9.021,19.584,11S17.979,14.584,16,14.584z",this._attr="object"==typeof e?e:a?a:{fill:"#000"}},projectLatLngs:function(){this._path&&this._path.remove();var t=this._map.latLngToLayerPoint(this._latlng),i=Raphael.pathBBox(this._pathString);this._path=this._paper.path(this._pathString).attr(this._attr).translate(t.x-1.05*i.width,t.y-1.15*i.height).toFront(),this._set.push(this._path)}}),t.Pulse=t.Layer.extend({initialize:function(i,e,a,r,o){t.Layer.prototype.initialize.call(this,o),this._latlng=i,this._radius="number"==typeof e?e:6,this._attr="object"==typeof e?e:"object"==typeof a?a:{fill:"#30a3ec",stroke:"#30a3ec"},this._pulseAttr="object"==typeof e?a:"object"==typeof r?r:{"stroke-width":3,stroke:this._attr.stroke},this._repeat=3},onRemove:function(i){t.Layer.prototype.onRemove.call(this,i),this._marker&&this._marker.remove(),this._pulse&&this._pulse.remove()},projectLatLngs:function(){this._marker&&this._marker.remove(),this._pulse&&this._pulse.remove();var t=this._map.latLngToLayerPoint(this._latlng);this._marker=this._paper.circle(t.x,t.y,this._radius).attr(this._attr),this._pulse=this._paper.circle(t.x,t.y,this._radius).attr(this._pulseAttr);var i=Raphael.animation({"0%":{transform:"s0.3",opacity:1},"100%":{transform:"s3.0",opacity:0,easing:"<"}},1e3);this._pulse.animate(i.repeat(this._repeat))}}),t.Polyline=t.Layer.extend({initialize:function(i,e,a){t.Layer.prototype.initialize.call(this,a),this._latlngs=i,this._attr=e||{fill:"#000",stroke:"#000"}},projectLatLngs:function(){this._set.clear(),this._path&&this._path.remove(),this._path=this._paper.path(this.getPathString()).attr(this._attr).toBack(),this._set.push(this._path)},getPathString:function(){for(var t=0,i=this._latlngs.length,e="";i>t;t++){var a=this._map.latLngToLayerPoint(this._latlngs[t]);e+=(t?"L":"M")+a.x+" "+a.y}return e}}),t.Polygon=t.Layer.extend({initialize:function(i,e,a){t.Layer.prototype.initialize.call(this,a),1==i.length&&i[0]instanceof Array&&(i=i[0]),this._latlngs=i,this._attr=e||{fill:"rgba(255, 0, 0, 0.5)",stroke:"#f00","stroke-width":2}},projectLatLngs:function(){this._path&&this._path.remove(),this._path=this._paper.path(this.getPathString()).attr(this._attr).toBack(),this._set.push(this._path)},getPathString:function(){for(var t=0,i=this._latlngs.length,e="";i>t;t++){var a=this._map.latLngToLayerPoint(this._latlngs[t]);e+=(t?"L":"M")+a.x+" "+a.y}return e+="Z"}}),t.PolygonGlow=t.Layer.extend({initialize:function(i,e,a){t.Layer.prototype.initialize.call(this,a),this._latlngs=i,this._attr=e||{fill:"rgba(255, 0, 0, 1)",stroke:"#f00","stroke-width":3}},onRemove:function(i){t.Layer.prototype.onRemove.call(this,i),this._path&&this._path.remove()},projectLatLngs:function(){this._path&&this._path.remove(),this._path=this._paper.path(this.getPathString()).attr(this._attr).toBack();var t=this._path,i=function(){t.animate({"fill-opacity":.25},1e3,"<",e)},e=function(){t.animate({"fill-opacity":1},1e3,"<",i)};e()},getPathString:function(){for(var t=0,i=this._latlngs.length,e="";i>t;t++){var a=this._map.latLngToLayerPoint(this._latlngs[t]);e+=(t?"L":"M")+a.x+" "+a.y}return e+="Z"}}),t.Bezier=t.Layer.extend({initialize:function(i,e,a){t.Layer.prototype.initialize.call(this,a),this._latlngs=i,this._attr=e},projectLatLngs:function(){this._path&&this._path.remove();var t=this._map.latLngToLayerPoint(this._latlngs[0]),i=this._map.latLngToLayerPoint(this._latlngs[1]),e=this.getControlPoint(t,i);this._path=this._paper.path("M"+t.x+" "+t.y+"Q"+e.x+" "+e.y+" "+i.x+" "+i.y).attr(this._attr).toBack(),this._set.push(this._path)},getControlPoint:function(t,i){var e={x:0,y:0};e.x=t.x+(i.x-[t.x])/2,e.y=t.y+(i.y-[t.y])/2;var a=0;return this.closeTo(t.x,i.x)&&!this.closeTo(t.y,i.y)?(a=1*(t.x-i.x)+15*(t.x>=i.x?1:-1),e.x=Math.max(t.x,i.x)+a):(a=1.5*(i.y-t.y)+15*(t.y<i.y?1:-1),e.y=Math.min(t.y,i.y)+a),e},closeTo:function(t,i){var e=15;return t-i>-e&&e>t-i}}),t.BezierAnim=t.Layer.extend({initialize:function(i,e,a,r){t.Layer.prototype.initialize.call(this,r),this._latlngs=i,this._attr=e,this._cb=a},_reset:function(){this._path&&this._path.remove(),this._sub&&this._sub.remove(),this._sub2&&this._sub2.remove(),this._pathBezier&&this._pathBezier.remove(),this._pathBezierAnimated&&this._pathBezierAnimated.remove(),this._markerAnimated&&this._markerAnimated.remove(),this._circleControls&&this._circleControls.remove(),this._arrayWithControls=[],this._arrayBezier=[]},onRemove:function(i){t.Layer.prototype.onRemove.call(this,i),this._reset()},projectLatLngs:function(){function t(t,i){this.update(t-(this.dx||0),i-(this.dy||0)),this.dx=t,this.dy=i}function i(){this.dx=this.dy=0}function t(t,i){this.update(t-(this.dx||0),i-(this.dy||0)),this.dx=t,this.dy=i}function i(){this.dx=this.dy=0}var e=this;e._reset();var a={fill:"#fff",stroke:"#000",cursor:"pointer"},r={fill:"#fff",stroke:"#000",followBezier:0},o={stroke:"blue","stroke-width":4,alongBezier:0},n={stroke:"blue","stroke-width":4,"stroke-linecap":"round",cursor:"pointer"},s=e._latlngs.length/4;if(s>1){e._circleControls=e._paper.set();for(var h=0;s>h;h++){var p=e._map.latLngToLayerPoint(e._latlngs[4*h]),l=L.point(this._latlngs[1+4*h]),c=L.point(this._latlngs[2+4*h]),_=e._map.latLngToLayerPoint(e._latlngs[3+4*h]);e._arrayBezier.push(["M",p.x,p.y]),e._arrayBezier.push(["C",p.x+l.x,p.y+l.y,_.x+c.x,_.y+c.y,_.x,_.y]);var u=[["M",p.x,p.y],["L",p.x+l.x,p.y+l.y],["M",_.x+c.x,_.y+c.y],["L",_.x,_.y]];e._arrayWithControls.push(u);var y=e._paper.path(u);y.attr({stroke:"#ccc","stroke-dasharray":"- "}),e._circleControls.push(y,e._paper.circle(p.x,p.y,5).attr(a),e._paper.circle(p.x+l.x,p.y+l.y,5).attr(a),e._paper.circle(_.x+c.x,_.y+c.y,5).attr(a),e._paper.circle(_.x,_.y,5).attr(a)),e._circleControls.hover(function(){console.log("HOVER IN"),e._map.dragging.disable()},function(){e._map.dragging.enable()}),e._circleControls[5*h+1].update=function(t,i){var a=this.attr("cx")+t,r=this.attr("cy")+i;this.attr({cx:a,cy:r});var o=this.data("bezierID");e._arrayBezier[2*o+0][1]=a,e._arrayBezier[2*o+0][2]=r,e._arrayWithControls[o][0][1]=a,e._arrayWithControls[o][0][2]=r,e._circleControls[5*o+2].update(t,i)},e._circleControls[5*h+1].data("bezierID",h),e._circleControls[5*h+2].update=function(t,i){var a=this.attr("cx")+t,r=this.attr("cy")+i;this.attr({cx:a,cy:r});var o=this.data("bezierID");console.log(e._arrayBezier),e._arrayBezier[2*o+1][1]=a,e._arrayBezier[2*o+1][2]=r,e._arrayWithControls[o][1][1]=a,e._arrayWithControls[o][1][2]=r,e._pathBezier.attr({path:e._arrayBezier}),e._circleControls[5*o+0].attr({path:e._arrayWithControls[o]})},e._circleControls[5*h+2].data("bezierID",h),e._circleControls[5*h+3].update=function(t,i){var a=this.attr("cx")+t,r=this.attr("cy")+i;this.attr({cx:a,cy:r});var o=this.data("bezierID");e._arrayBezier[2*o+1][3]=a,e._arrayBezier[2*o+1][4]=r,e._arrayWithControls[o][2][1]=a,e._arrayWithControls[o][2][2]=r,e._pathBezier.attr({path:e._arrayBezier}),e._circleControls[5*o+0].attr({path:e._arrayWithControls[o]})},e._circleControls[5*h+3].data("bezierID",h),e._circleControls[5*h+4].update=function(t,i){var a=this.attr("cx")+t,r=this.attr("cy")+i;this.attr({cx:a,cy:r});var o=this.data("bezierID");e._arrayBezier[2*o+1][5]=a,e._arrayBezier[2*o+1][6]=r,e._arrayWithControls[o][3][1]=a,e._arrayWithControls[o][3][2]=r,e._circleControls[5*o+3].update(t,i)},e._circleControls[5*h+4].data("bezierID",h)}e._circleControls.drag(t,i),e._circleControls.hide(),e._pathBezier=this._paper.path(e._arrayBezier).hide(),e._pathBezier.click(function(){e._cb&&e._cb.onClickPath(e.options.info)}),e._pathBezierAnimated=e._paper.path().data("bezierPath",e._pathBezier).data("pathLength",e._pathBezier.getTotalLength()).data("reverse",!1).attr(o),e._markerAnimated=e._paper.image(e.options.transition.icon.url).data("bezierPath",e._pathBezier).data("pathLength",e._pathBezier.getTotalLength()).data("reverse",!1).attr(r),e._markerAnimated.hide(),this._paper.customAttributes.alongBezier=function(t){var i=this.data("reverse"),e=this.data("pathLength");return t>0?{path:this.data("bezierPath").getSubpath(i?(1-t)*e:0,i?e:t*e)}:void 0},this._paper.customAttributes.followBezier=function(t){this.show();var i=this.data("reverse"),a=this.data("pathLength"),r=this.data("bezierPath").getPointAtLength(i?a:t*a),o=0;return t>0&&(o=5),{href:e.options.transition.icon.url,x:r.x-e.options.transition.icon.anchor[0],y:r.y-e.options.transition.icon.anchor[1],width:e.options.transition.icon.size[0],height:e.options.transition.icon.size[1]}},setTimeout(function(){e._markerAnimated.stop().animate({followBezier:.5},e.options.animationDuration,function(){}),e._pathBezierAnimated.stop().animate({alongBezier:1},e.options.animationDuration,function(){e._pathBezierAnimated.hide(),e._pathBezier.attr(n),e._pathBezier.show(),e._circleControls&&e._circleControls.show()})},e.options.startAnimateTimeout)}else{var p=this._map.latLngToLayerPoint(this._latlngs[0]),l=L.point(this._latlngs[1]),c=L.point(this._latlngs[2]),_=this._map.latLngToLayerPoint(this._latlngs[3]),g=p.x,d=p.y,f=p.x+l.x,m=p.y+l.y,x=_.x+c.x,v=_.y+c.y,z=_.x,b=_.y,P=[["M",g,d],["C",f,m,x,v,z,b]];e.path2=[["M",g,d],["L",f,m],["M",x,v],["L",z,b]];var B=e._path=this._paper.path(P).hide();if(e._path.click(function(){e._cb&&e._cb.onClickPath(e.options.info)}),e.options.editor){var u=this._circleControls=this._paper.set(this._paper.path(e.path2).attr({stroke:"#ccc","stroke-dasharray":". "}),this._paper.circle(g,d,5).attr(a),this._paper.circle(f,m,5).attr(a),this._paper.circle(x,v,5).attr(a),this._paper.circle(z,b,5).attr(a)).hover(function(){e._map.dragging.disable()},function(){if(e._map.dragging.enable(),e._cb){var t=e.options.info;t.controls=[[e.path2[1][1]-e.path2[0][1],e.path2[1][2]-e.path2[0][2]],[e.path2[2][1]-e.path2[0][1],e.path2[2][2]-e.path2[0][2]]],e._cb.onMovePath(t)}});this._circleControls.hide(),u[1].update=function(t,i){var a=this.attr("cx")+t,r=this.attr("cy")+i;this.attr({cx:a,cy:r}),P[0][1]=a,P[0][2]=r,e.path2[0][1]=a,e.path2[0][2]=r,u[2].update(t,i)},u[2].update=function(t,i){var a=this.attr("cx")+t,r=this.attr("cy")+i;this.attr({cx:a,cy:r}),P[1][1]=a,P[1][2]=r,e.path2[1][1]=a,e.path2[1][2]=r,B.attr({path:P}),u[0].attr({path:e.path2})},u[3].update=function(t,i){var a=this.attr("cx")+t,r=this.attr("cy")+i;this.attr({cx:a,cy:r}),P[1][3]=a,P[1][4]=r,e.path2[2][1]=a,e.path2[2][2]=r,B.attr({path:P}),u[0].attr({path:e.path2})},u[4].update=function(t,i){var a=this.attr("cx")+t,r=this.attr("cy")+i;this.attr({cx:a,cy:r}),P[1][5]=a,P[1][6]=r,e.path2[3][1]=a,e.path2[3][2]=r,u[3].update(t,i)},u.drag(t,i)}{e._sub=e._paper.path().data("bezierPath",B).data("pathLength",B.getTotalLength()).data("reverse",!1).attr(o),e._sub2=e._paper.image(e.options.transition.icon.url).data("bezierPath",B).data("pathLength",B.getTotalLength()).data("reverse",!1).attr(r)}e._sub2.hide(),this._paper.customAttributes.alongBezier=function(t){var i=this.data("reverse"),e=this.data("pathLength");return t>0?{path:this.data("bezierPath").getSubpath(i?(1-t)*e:0,i?e:t*e)}:void 0},this._paper.customAttributes.followBezier=function(t){this.show();var i=this.data("reverse"),a=this.data("pathLength"),r=this.data("bezierPath").getPointAtLength(i?a:t*a),o=0;return t>0&&(o=5),{href:e.options.transition.icon.url,x:r.x-e.options.transition.icon.anchor[0],y:r.y-e.options.transition.icon.anchor[1],width:e.options.transition.icon.size[0],height:e.options.transition.icon.size[1]}},setTimeout(function(){e._sub2.stop().animate({followBezier:1},e.options.animationDuration,function(){e._sub2.hide()}),e._sub.stop().animate({alongBezier:1},e.options.animationDuration,function(){e._sub.hide(),e._path.attr(n),e._path.show(),e._circleControls&&e._circleControls.show()})},e.options.startAnimateTimeout)}},getControlPoint:function(t,i){var e={x:0,y:0};e.x=t.x+(i.x-[t.x])/2,e.y=t.y+(i.y-[t.y])/2;var a=0;return this.closeTo(t.x,i.x)&&!this.closeTo(t.y,i.y)?(a=1*(t.x-i.x)+15*(t.x>=i.x?1:-1),e.x=Math.max(t.x,i.x)+a):(a=1.5*(i.y-t.y)+15*(t.y<i.y?1:-1),e.y=Math.min(t.y,i.y)+a),e},closeTo:function(t,i){var e=15;return t-i>-e&&e>t-i}}),t.FeatureGroup=L.FeatureGroup.extend({initialize:function(t,i){L.FeatureGroup.prototype.initialize.call(this,t,i)},animate:function(t,i,e,a){this.eachLayer(function(r){r.animate(t,i,e,a)})},onAdd:function(t){L.FeatureGroup.prototype.onAdd.call(this,t),this._set=this._map._paper.set();for(i in this._layers)this._set.push(this._layers[i]._set)},hover:function(t,i,e,a){return this.eachLayer(function(r){r.hover(t,i,e,a)}),this},attr:function(t,i){return this.eachLayer(function(e){e.attr(t,i)}),this}}),function(){function i(i){return t.FeatureGroup.extend({initialize:function(t,i){this._layers={},this._options=i,this.setLatLngs(t)},setLatLngs:function(t){var e=0,a=t.length;for(this.eachLayer(function(i){a>e?i.setLatLngs(t[e++]):this.removeLayer(i)},this);a>e;)this.addLayer(new i(t[e++],this._options));return this}})}t.MultiPolyline=i(t.Polyline),t.MultiPolygon=i(t.Polygon)}(),t.GeoJSON=t.FeatureGroup.extend({initialize:function(t,i){L.Util.setOptions(this,i),this._geojson=t,this._layers={},t&&this.addGeoJSON(t)},addGeoJSON:function(i){var e,a,r=i.features;if(r)for(e=0,a=r.length;a>e;e++)this.addGeoJSON(r[e]);else{var o="Feature"===i.type,n=o?i.geometry:i,s=t.GeoJSON.geometryToLayer(n,this.options.pointToLayer);this.fire("featureparse",{layer:s,properties:i.properties,geometryType:n.type,bbox:i.bbox,id:i.id,geometry:i.geometry}),this.addLayer(s)}}}),L.Util.extend(t.GeoJSON,{geometryToLayer:function(i,e){var a,r,o,n,s,h=i.coordinates,p=[];switch(i.type){case"Point":return a=this.coordsToLatLng(h),e?e(a):new t.Marker(a);case"MultiPoint":for(o=0,n=h.length;n>o;o++)a=this.coordsToLatLng(h[o]),s=e?e(a):new t.Marker(a),p.push(s);return new t.FeatureGroup(p);case"LineString":return r=this.coordsToLatLngs(h),new t.Polyline(r);case"Polygon":return r=this.coordsToLatLngs(h,1),new t.Polygon(r);case"MultiLineString":return r=this.coordsToLatLngs(h,1),new t.MultiPolyline(r);case"MultiPolygon":return r=this.coordsToLatLngs(h,2),new t.MultiPolygon(r);case"GeometryCollection":for(o=0,n=i.geometries.length;n>o;o++)s=this.geometryToLayer(i.geometries[o],e),p.push(s);return new t.FeatureGroup(p);default:throw new Error("Invalid GeoJSON object.")}},coordsToLatLng:function(t,i){var e=parseFloat(t[i?0:1]),a=parseFloat(t[i?1:0]);return new L.LatLng(e,a,!0)},coordsToLatLngs:function(t,i,e){var a,r,o,n=[];for(r=0,o=t.length;o>r;r++)a=i?this.coordsToLatLngs(t[r],i-1,e):this.coordsToLatLng(t[r],e),n.push(a);return n}})}();